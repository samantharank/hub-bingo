<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HUB Bingo</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:Arial,sans-serif;background:#1a1a2e;color:#eee;min-height:100vh;}
h1{text-align:center;padding:14px 0 6px;font-size:2rem;color:#e94560;letter-spacing:2px;}
.page{display:none;max-width:680px;margin:0 auto;padding:16px;}
.page.on{display:block;}
.btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:1rem;font-weight:bold;}
.btn:hover{opacity:.85;}
.red{background:#e94560;color:#fff;}
.blue{background:#0f3460;color:#eee;}
.green{background:#43a047;color:#fff;}
.sm{padding:6px 14px;font-size:.85rem;}
input{width:100%;padding:10px;border-radius:8px;border:none;background:#16213e;color:#eee;font-size:.95rem;margin-bottom:10px;}
.err{color:#e94560;font-size:.85rem;margin-bottom:8px;}
.badge{background:#e94560;color:#fff;padding:4px 14px;border-radius:20px;display:inline-block;font-size:.8rem;margin-bottom:12px;}
.row{display:grid;grid-template-columns:1fr auto;gap:8px;margin-bottom:8px;}
.row input{margin-bottom:0;}
.xbtn{background:#e94560;border:none;border-radius:8px;color:#fff;font-size:1.1rem;cursor:pointer;padding:0 12px;}
.ball{width:90px;height:90px;border-radius:50%;background:#e94560;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:bold;box-shadow:0 0 24px #e9456088;flex-shrink:0;}
.ball.empty{background:#0f3460;box-shadow:none;color:#aaa;font-size:.8rem;text-align:center;padding:8px;line-height:1.4;}
.bl{font-size:1rem;}.bn{font-size:2.2rem;line-height:1;}
.chips{display:flex;flex-wrap:wrap;gap:5px;max-height:80px;overflow-y:auto;}
.chip{background:#0f3460;border-radius:20px;padding:3px 9px;font-size:.75rem;}
.chip.B{border-left:3px solid #4fc3f7;}.chip.I{border-left:3px solid #aed581;}
.chip.N{border-left:3px solid #ffb74d;}.chip.G{border-left:3px solid #f06292;}
.chip.O{border-left:3px solid #ce93d8;}
.gtop{display:flex;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap;}
.ch{height:36px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;font-weight:bold;}
.cgrid{display:grid;grid-template-columns:repeat(5,62px);gap:4px;}
.cell{width:62px;height:62px;background:#16213e;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:bold;cursor:pointer;border:2px solid transparent;user-select:none;transition:background .15s;}
.cell.free{background:#e94560;color:#fff;cursor:default;}
.cell.marked{background:#e94560;color:#fff;}
.cell.hot{border-color:#ffd700;}
.cell.win{background:#ffd700!important;color:#000;animation:pu .5s infinite alternate;}
@keyframes pu{from{transform:scale(1)}to{transform:scale(1.08)}}
.wm{font-size:1.6rem;color:#ffd700;font-weight:bold;text-align:center;margin:10px 0;display:none;}
.bar{display:flex;justify-content:center;gap:10px;margin-top:16px;flex-wrap:wrap;}
.hplist{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:10px 0;}
.hp{background:#16213e;border-radius:8px;padding:6px 14px;font-size:.85rem;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;align-items:center;justify-content:center;}
.modal.on{display:flex;}
.mbox{background:#16213e;border-radius:12px;padding:24px;max-width:620px;width:95%;max-height:80vh;display:flex;flex-direction:column;}
.mbox h2{color:#e94560;margin-bottom:8px;}
.mbox p{font-size:.85rem;color:#aaa;margin-bottom:10px;}
textarea{flex:1;background:#0f3460;color:#aed581;border:none;border-radius:8px;padding:12px;font-family:monospace;font-size:.8rem;resize:none;min-height:220px;width:100%;}
</style>
</head>
<body>
<h1>üé± BINGO</h1>

<!-- P1: player email entry -->
<div id="p1" class="page on" style="max-width:420px;text-align:center;">
  <p style="color:#aaa;margin-bottom:16px;">Enter your HUB email to load your bingo card</p>
  <input type="email" id="pEmail" placeholder="firstname.lastname@hubinternational.com" onkeydown="if(event.key==='Enter')joinGame()"/>
  <div id="pErr" class="err"></div>
  <button class="btn red" style="width:100%;margin-bottom:10px;" onclick="joinGame()">Load My Card</button>
  <button class="btn blue sm" onclick="go('hLogin')">Host</button>
</div>

<!-- P2: player card -->
<div id="p2" class="page" style="text-align:center;">
  <p id="pGreet" style="color:#aaa;font-size:.85rem;margin-bottom:10px;"></p>
  <div class="gtop" style="justify-content:center;">
    <div id="pBall" class="ball empty">Waiting...</div>
    <div style="flex:1;min-width:160px;">
      <div style="color:#aaa;font-size:.8rem;margin-bottom:5px;">Called: <span id="pCount">0</span>/75</div>
      <div class="chips" id="pChips"></div>
    </div>
  </div>
  <div style="text-align:center;">
    <div class="cgrid" style="display:inline-grid;margin-bottom:4px;" id="pHdr"></div>
    <div class="cgrid" style="display:inline-grid;" id="pGrid"></div>
  </div>
  <div id="pWin" class="wm">üéâ BINGO! You win!</div>
  <div style="color:#555;font-size:.75rem;margin-top:8px;">Tap a <span style="color:#ffd700;">highlighted</span> number to mark it off</div>
  <div class="bar"><button class="btn blue sm" onclick="switchPlayer()">‚Üê Switch Player</button></div>
</div>

<!-- H1: host login -->
<div id="hLogin" class="page" style="max-width:340px;text-align:center;">
  <div class="badge">üéô Host Login</div><br>
  <input type="password" id="hPw" placeholder="Enter host password" onkeydown="if(event.key==='Enter')tryLogin()"/>
  <div id="hPwErr" class="err"></div>
  <button class="btn red" style="width:100%;margin-bottom:10px;" onclick="tryLogin()">Login</button>
  <button class="btn blue sm" onclick="go('p1')">‚Üê Back</button>
</div>

<!-- H2: host setup -->
<div id="hSetup" class="page" style="text-align:center;">
  <div class="badge">üéô HOST MODE</div>
  <p style="color:#aaa;margin-bottom:14px;">Enter player emails to generate cards and start the game</p>
  <div id="hList">
    <div class="row"><input type="email" placeholder="firstname.lastname@hubinternational.com"/><button class="xbtn" onclick="removeRow(this)">√ó</button></div>
    <div class="row"><input type="email" placeholder="firstname.lastname@hubinternational.com"/><button class="xbtn" onclick="removeRow(this)">√ó</button></div>
  </div>
  <button class="btn blue sm" onclick="addRow()" style="margin:8px 0 16px;">+ Add Player</button><br>
  <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
    <button class="btn green" onclick="exportJSON()">üìã Export JSON</button>
    <button class="btn red" onclick="startGame()">‚ñ∂ Start Game</button>
  </div>
  <div class="bar"><button class="btn blue sm" onclick="go('p1')">Log out</button></div>
</div>

<!-- H3: host game -->
<div id="hGame" class="page">
  <div style="text-align:center;margin-bottom:6px;"><div class="badge">üéô HOST MODE</div></div>
  <div class="gtop">
    <div id="hBall" class="ball empty">Draw a number!</div>
    <button class="btn red" onclick="drawNumber()" style="font-size:1.1rem;padding:12px 24px;">üé≤ Draw Number</button>
    <div style="flex:1;min-width:160px;">
      <div style="color:#aaa;font-size:.8rem;margin-bottom:5px;">Called: <span id="hCount">0</span>/75</div>
      <div class="chips" id="hChips"></div>
    </div>
  </div>
  <div id="hPlayers" class="hplist"></div>
  <div class="bar">
    <button class="btn red sm" onclick="newGame()">üîÑ New Game</button>
    <button class="btn blue sm" onclick="go('p1')">Log out</button>
  </div>
</div>

<!-- JSON modal -->
<div id="jModal" class="modal">
  <div class="mbox">
    <h2>üìã Power Automate JSON</h2>
    <p>Copy and paste into your Power Automate flow.</p>
    <textarea id="jBox" readonly></textarea>
    <div class="bar" style="margin-top:10px;">
      <button class="btn green" onclick="copyJSON(this)">Copy JSON</button>
      <button class="btn blue" onclick="document.getElementById('jModal').classList.remove('on')">Close</button>
    </div>
  </div>
</div>

<script>
const COLS=['B','I','N','G','O'];
const RANGES={B:[1,15],I:[16,30],N:[31,45],G:[46,60],O:[61,75]};
const CC=['#4fc3f7','#aed581','#ffb74d','#f06292','#ce93d8'];
const PW='HUBbingo2026';
const SK='hub-bingo-v2';
const DOM='hubinternational.com';
const SP_URL='https://samantharank.github.io/hub-bingo/';

let state=null,pEmail='',pCard=null,pCalled=[],pTimer=null;

const rr=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const fn=e=>{const p=e.split('@')[0].split('.')[0];return p[0].toUpperCase()+p.slice(1).toLowerCase();};
const full=e=>e.split('@')[0].split('.').map(p=>p[0].toUpperCase()+p.slice(1).toLowerCase()).join(' ');
const col=n=>COLS[Math.floor((n-1)/15)];

function go(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));
  document.getElementById(id).classList.add('on');
}

function genCard(){
  let c=[];
  COLS.forEach(k=>{const[a,b]=RANGES[k],ns=[];while(ns.length<5){const n=rr(a,b);if(!ns.includes(n))ns.push(n);}for(let r=0;r<5;r++)c.push({num:ns[r],marked:false,free:false});});
  c[12].free=true;c[12].marked=true;
  return c;
}

function win(card){
  for(let r=0;r<5;r++)if([0,1,2,3,4].every(c=>card[c*5+r].marked))return true;
  for(let c=0;c<5;c++)if([0,1,2,3,4].every(r=>card[c*5+r].marked))return true;
  if([0,1,2,3,4].every(i=>card[i*5+i].marked))return true;
  if([0,1,2,3,4].every(i=>card[i*5+(4-i)].marked))return true;
  return false;
}

function winCells(card){
  const w=new Set();
  for(let r=0;r<5;r++)if([0,1,2,3,4].every(c=>card[c*5+r].marked))[0,1,2,3,4].forEach(c=>w.add(r*5+c));
  for(let c=0;c<5;c++)if([0,1,2,3,4].every(r=>card[c*5+r].marked))[0,1,2,3,4].forEach(r=>w.add(r*5+c));
  if([0,1,2,3,4].every(i=>card[i*5+i].marked))[0,1,2,3,4].forEach(i=>w.add(i*5+i));
  if([0,1,2,3,4].every(i=>card[i*5+(4-i)].marked))[0,1,2,3,4].forEach(i=>w.add(i*5+(4-i)));
  return w;
}

function save(g){try{localStorage.setItem(SK,JSON.stringify(g));}catch(e){}}
function load(){try{const d=localStorage.getItem(SK);return d?JSON.parse(d):null;}catch(e){return null;}}
function clear(){try{localStorage.removeItem(SK);}catch(e){}}

// HOST
function tryLogin(){
  if(document.getElementById('hPw').value===PW){
    document.getElementById('hPw').value='';
    document.getElementById('hPwErr').textContent='';
    const g=load();
    if(g&&g.active){state=g;renderHost();go('hGame');}
    else go('hSetup');
  }else{document.getElementById('hPwErr').textContent='Incorrect password.';}
}

function addRow(){
  const d=document.createElement('div');d.className='row';
  d.innerHTML=`<input type="email" placeholder="firstname.lastname@hubinternational.com"/><button class="xbtn" onclick="removeRow(this)">√ó</button>`;
  document.getElementById('hList').appendChild(d);
}
function removeRow(b){b.parentElement.remove();}

function startGame(){
  const emails=[...document.querySelectorAll('#hList input')].map(i=>i.value.trim().toLowerCase()).filter(e=>e);
  if(!emails.length){alert('Add at least one email.');return;}
  state={players:emails.map(e=>({email:e,name:full(e),card:genCard()})),calledNums:[],active:true};
  save(state);renderHost();go('hGame');
}

function drawNumber(){
  if(!state)return;
  if(state.calledNums.length>=75){alert('All 75 numbers called!');return;}
  let n;do{n=rr(1,75);}while(state.calledNums.includes(n));
  state.calledNums.push(n);save(state);renderHost();
}

function renderHost(){
  const called=state.calledNums,last=called.length?called[called.length-1]:null;
  const ball=document.getElementById('hBall');
  if(last){ball.className='ball';ball.innerHTML=`<span class="bl">${col(last)}</span><span class="bn">${last}</span>`;}
  else{ball.className='ball empty';ball.innerHTML='Draw a number!';}
  document.getElementById('hCount').textContent=called.length;
  const chips=document.getElementById('hChips');chips.innerHTML='';
  [...called].reverse().forEach(n=>{const c=col(n);const s=document.createElement('span');s.className=`chip ${c}`;s.textContent=`${c}${n}`;chips.appendChild(s);});
  const hp=document.getElementById('hPlayers');hp.innerHTML='';
  state.players.forEach(p=>{const d=document.createElement('div');d.className='hp';d.textContent=`${fn(p.email)} ${win(p.card)?'üéâ':''}`;hp.appendChild(d);});
}

function newGame(){
  if(!confirm('Start a new game? This will clear the current game.'))return;
  clear();state=null;
  document.getElementById('hList').innerHTML=`
    <div class="row"><input type="email" placeholder="firstname.lastname@hubinternational.com"/><button class="xbtn" onclick="removeRow(this)">√ó</button></div>
    <div class="row"><input type="email" placeholder="firstname.lastname@hubinternational.com"/><button class="xbtn" onclick="removeRow(this)">√ó</button></div>`;
  go('hSetup');
}

// JSON export
function buildHTML(email,card){
  const f=fn(email);
  let hdr=COLS.map((l,i)=>`<th style="width:60px;height:36px;background:${CC[i]};color:#000;border-radius:6px;text-align:center;font-size:1.2rem;font-weight:bold;">${l}</th>`).join('');
  let rows='';
  for(let r=0;r<5;r++){
    let cells='';
    for(let c=0;c<5;c++){const cell=card[c*5+r];cells+=`<td style="width:60px;height:60px;background:${cell.free?'#e94560':'#16213e'};border-radius:6px;text-align:center;vertical-align:middle;color:#eee;font-size:1.1rem;font-weight:bold;">${cell.free?'FREE':cell.num}</td>`;}
    rows+=`<tr>${cells}</tr>`;
  }
  return `<div style="font-family:Arial,sans-serif;max-width:400px;margin:0 auto;background:#1a1a2e;padding:24px;border-radius:12px;"><h1 style="text-align:center;color:#e94560;letter-spacing:2px;margin-bottom:8px;">üé± BINGO</h1><p style="text-align:center;color:#eee;margin-bottom:16px;">Hi <strong>${f}</strong>, here is your card for today's game!</p><table style="border-collapse:separate;border-spacing:4px;margin:0 auto;"><tr>${hdr}</tr>${rows}</table><p style="text-align:center;color:#aaa;font-size:.8rem;margin-top:16px;">Mark off numbers as they're called. First to get 5 in a row wins! üçÄ</p><div style="text-align:center;margin-top:20px;"><a href="${SP_URL}" style="background:#e94560;color:#fff;padding:12px 28px;border-radius:8px;text-decoration:none;font-weight:bold;font-size:1rem;">üé± Play Bingo Online</a></div></div>`;
}

function exportJSON(){
  const emails=[...document.querySelectorAll('#hList input')].map(i=>i.value.trim().toLowerCase()).filter(e=>e);
  if(!emails.length){alert('Add at least one email first.');return;}
  const data=emails.map(e=>{const card=genCard();return{name:full(e),email:e,cardHTML:buildHTML(e,card)};});
  document.getElementById('jBox').value=JSON.stringify(data,null,2);
  document.getElementById('jModal').classList.add('on');
}

function copyJSON(btn){
  document.getElementById('jBox').select();document.execCommand('copy');
  btn.textContent='‚úÖ Copied!';setTimeout(()=>btn.textContent='Copy JSON',2000);
}

// PLAYER
function joinGame(){
  const e=document.getElementById('pEmail').value.trim().toLowerCase();
  if(!e){document.getElementById('pErr').textContent='Please enter your email.';return;}
  if(!e.endsWith('@'+DOM)){document.getElementById('pErr').textContent=`Please use your @${DOM} email.`;return;}
  pEmail=e;pCard=null;document.getElementById('pErr').textContent='';
  loadPlayerGame();
}

function loadPlayerGame(){
  const g=load();
  if(!g||!g.active){document.getElementById('pErr').textContent='No active game yet. Ask your host to start the game first.';return;}
  const player=g.players.find(p=>p.email===pEmail);
  if(!player){document.getElementById('pErr').textContent=`No card found for ${pEmail}. Ask your host to add your email.`;return;}
  if(!pCard)pCard=player.card.map(c=>({...c}));
  pCalled=g.calledNums||[];
  document.getElementById('pGreet').textContent=`üëã Hi ${fn(pEmail)}! Auto-refreshing every 5s`;
  renderPlayer();go('p2');
  if(pTimer)clearInterval(pTimer);
  pTimer=setInterval(()=>{const g2=load();if(!g2)return;pCalled=g2.calledNums||[];renderPlayer();},5000);
}

function renderPlayer(){
  const called=pCalled,last=called.length?called[called.length-1]:null;
  const ball=document.getElementById('pBall');
  if(last){ball.className='ball';ball.innerHTML=`<span class="bl">${col(last)}</span><span class="bn">${last}</span>`;}
  else{ball.className='ball empty';ball.innerHTML='Waiting...';}
  document.getElementById('pCount').textContent=called.length;
  const chips=document.getElementById('pChips');chips.innerHTML='';
  [...called].reverse().forEach(n=>{const c=col(n);const s=document.createElement('span');s.className=`chip ${c}`;s.textContent=`${c}${n}`;chips.appendChild(s);});
  const hdr=document.getElementById('pHdr');hdr.innerHTML='';
  COLS.forEach((l,i)=>{const d=document.createElement('div');d.className='ch';d.style.cssText=`width:62px;background:${CC[i]};color:#000;`;d.textContent=l;hdr.appendChild(d);});
  const won=win(pCard),wc=won?winCells(pCard):new Set();
  const grid=document.getElementById('pGrid');grid.innerHTML='';
  for(let r=0;r<5;r++){
    for(let c=0;c<5;c++){
      const idx=c*5+r,cell=pCard[idx],di=r*5+c;
      const div=document.createElement('div');
      let cls='cell';
      if(cell.free)cls+=' free';
      else if(wc.has(di))cls+=' win';
      else if(cell.marked)cls+=' marked';
      else if(called.includes(cell.num))cls+=' hot';
      div.className=cls;div.textContent=cell.free?'FREE':cell.num;
      if(!cell.free){const i=idx;div.onclick=()=>{if(pCalled.includes(pCard[i].num)){pCard[i].marked=!pCard[i].marked;renderPlayer();}};}
      grid.appendChild(div);
    }
  }
  document.getElementById('pWin').style.display=won?'block':'none';
}

function switchPlayer(){
  if(pTimer)clearInterval(pTimer);
  pEmail='';pCard=null;pCalled=[];
  document.getElementById('pEmail').value='';
  document.getElementById('pErr').textContent='';
  go('p1');
}
</script>
</body>
</html>